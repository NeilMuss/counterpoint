Adaptive Sampling And Keyframes

Overview
- The stroke outline is generated by sampling a skeleton path (cubic Beziers), stamping counterpoints at those samples, and then building envelopes/bridges.
- Sampling can be adaptive (recursive) or keyframeGrid (keyframe-driven).
- Keyframes are evaluated using arclength progress, not u, so timing is consistent even when samples cluster.

Key Terms
- u_grid: parametric value derived from the keyframeGrid t->u lookup (segment-local).
- u_geom: parametric value used to evaluate geometry (point+tangent). This stays monotone.
- t_progress: normalized arclength progress computed from the ordered sample points.
- alpha: a keyframed modulation value used by envelope construction (not keyframe timing).

Sampling Pipeline (adaptive)
1) Flatten the Bezier path into a polyline for tangent evaluation and fallback geometry.
2) Adaptive recursion builds an ordered sample list in u_geom:
   - Evaluate start and end samples.
   - Insert midpoint sample.
   - Split when envelope error exceeds tolerance or rotation change exceeds threshold.
3) Hard spacing pass:
   - Enforce a maximum spacing between consecutive samples (spec.sampling.maxSpacing or baseSpacing).
   - Insert interpolated samples to keep distance <= maxSpacing.
4) Arclength progress:
   - Walk the ordered samples and accumulate chord lengths.
   - t_progress = cumulativeLength / totalLength.
5) Per-sample evaluation:
   - width, height, theta, offset, alpha are evaluated at t_progress.
   - This keeps keyframes aligned to stroke length rather than u.

Sampling Pipeline (keyframeGrid)
1) Flatten the Bezier path once and compute cumulative arclength.
2) Collect keyframe times across tracks and build sorted unique T (+0,1).
3) For each interval, emit samples only when a track changes or coverage is needed by maxSpacing.
4) Map each t in T to u_grid via polyline interpolation, then evaluate cubic for u_geom.
5) Optional refinement inserts midpoints when rotation exceeds the threshold.
6) Compute t_progress from the final ordered samples and evaluate tracks at t_progress.

Keyframe Evaluation
- All ParamTrack keyframes are evaluated at t_progress.
- This includes width, height, theta, offset, and alpha.
- Keyframe timing is unaffected by adaptive recursion or sample clustering.

Alpha Semantics
- alpha is evaluated at t_progress and stored on each Sample.
- alpha does not modify t_progress or u_geom.
- alpha affects envelope construction behavior only.

CSV Dumps
- Sample CSV output includes u_grid, u_geom, and t_progress for auditing.
- The column t_eval_used_for_tracks equals t_progress for JSON specs.

Notes
- If you want deterministic spacing, set sampling.maxSpacing (or baseSpacing).
- If you want dense sampling without changing adaptive tolerances, reduce maxSpacing.
